# ===== ANGULAR ROUTING FIX - KORRIGIERTE VERSION =====
# Speziell für Angular SPA mit direkten URL-Aufrufen
# Löst das Problem: 404 bei Browser-Refresh auf Unterseiten

# ===== REWRITE ENGINE AKTIVIEREN =====
RewriteEngine On

# ===== ANGULAR SPA ROUTING - ERWEITERTE KONFIGURATION =====
# Basis-Pfad setzen (wichtig für Subdirectories)
RewriteBase /

# Existierende Dateien und Ordner nicht umleiten
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l

# Spezielle Ausnahmen für Assets
RewriteCond %{REQUEST_URI} !^/assets/
RewriteCond %{REQUEST_URI} !^/favicon\.ico$
RewriteCond %{REQUEST_URI} !^/.*\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico|json|xml|txt)$

# Alle anderen Anfragen an index.html weiterleiten
RewriteRule ^.*$ /index.html [L,QSA]

# ===== ALTERNATIVE METHODE (falls obige nicht funktioniert) =====
# Kommentieren Sie die obigen Regeln aus und verwenden Sie diese:
# RewriteCond %{REQUEST_FILENAME} !-f
# RewriteCond %{REQUEST_FILENAME} !-d
# RewriteRule . /index.html [L]

# ===== FEHLERBEHANDLUNG =====
# Custom 404 Error Page (optional)
ErrorDocument 404 /index.html

# ===== MIME TYPES =====
<IfModule mod_mime.c>
    # JavaScript
    AddType application/javascript .js
    AddType application/json .json
    
    # CSS
    AddType text/css .css
    
    # Fonts
    AddType font/woff .woff
    AddType font/woff2 .woff2
    
    # Images
    AddType image/svg+xml .svg
    AddType image/webp .webp
</IfModule>

# ===== COMPRESSION =====
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# ===== CACHING =====
<IfModule mod_expires.c>
    ExpiresActive On
    
    # HTML: Keine Cache (für SPA wichtig)
    ExpiresByType text/html "access plus 0 seconds"
    
    # CSS und JavaScript: 1 Woche
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    
    # Bilder: 1 Monat
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    
    # Fonts: 1 Jahr
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# ===== CACHE CONTROL =====
<IfModule mod_headers.c>
    # HTML: Kein Cache für SPA
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # CSS und JS: Cache erlaubt
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=604800"
    </FilesMatch>
    
    # Bilder: Lange Cache-Zeit
    <FilesMatch "\.(png|jpg|jpeg|gif|svg|webp|ico)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
</IfModule>

# ===== SECURITY =====
# Verzeichnis-Browsing deaktivieren
Options -Indexes

# Sensible Dateien schützen
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# ===== DEBUGGING (temporär aktivieren bei Problemen) =====
# RewriteLog /tmp/rewrite.log
# RewriteLogLevel 3

# ===== FALLBACK FÜR VERSCHIEDENE SERVER =====
# Falls der Server mod_rewrite nicht unterstützt:
<IfModule !mod_rewrite.c>
    # Fallback: Alle 404-Fehler zu index.html
    ErrorDocument 404 /index.html
</IfModule>

